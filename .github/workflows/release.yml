on:
  push:
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  release:
    name: "Create Release"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Parse changelog
      run: |
        echo "GITHUB_REF is: ${GITHUB_REF}"
        TAG=$(echo "${GITHUB_REF}" | cut -d'/' -f3)
        echo "Extracted TAG is: $TAG"
        CHANGELOG_ENTRY=$(./tools/changelog.sh $TAG)
        echo "CHANGELOG_ENTRY is: $CHANGELOG_ENTRY"
        echo "CHANGELOG_ENTRY=$CHANGELOG_ENTRY" >> $GITHUB_ENV
        if [[ $TAG == *-rc* ]]; then
          echo "PRERELEASE=true" >> $GITHUB_ENV
        else
          echo "PRERELEASE=false" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Version ${{ github.ref }}
        body: ${{ env.CHANGELOG_ENTRY }}
        prerelease: ${{ env.PRERELEASE }}
